# HTTP to HTTPS Redirect
server {
    listen 80;
    listen [::]:80;
    server_name jetestemonsite.apdp.mc;
    return 301 https://$server_name$request_uri;
}

# HTTPS Configuration
server {
    listen 443 ssl;
    server_name jetestemonsite.apdp.mc;

    # SSL Configuration
    ssl_certificate /etc/ssl/certs/chatbot_apdp_mc.crt;
    ssl_certificate_key /etc/ssl/private/chatbot_apdp_mc.key;
    ssl_protocols TLSv1.2 TLSv1.3;

    # Security Headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;

    server_tokens off;
    client_max_body_size 50M;

    # ==================================================
    # SECURITY: ATTACK DETECTION & BLOCKING
    # ==================================================
    
    # Block malicious bots
    if ($bad_bot) {
        return 444;
    }
    
    # Block suspicious HTTP methods
    if ($suspicious_method) {
        return 405;
    }
    
    # Block attacks (except for trusted IPs)
    if ($is_attack) {
        set $block_attack A;
    }
    if ($trusted_ip = 0) {
        set $block_attack "${block_attack}B";
    }
    if ($block_attack = AB) {
        return 444;  # Close connection silently (logged via main access_log)
    }
    
    # Apply general rate limiting (allows bursts for page loads)
    limit_req zone=general burst=30 nodelay;
    limit_req_status 429;

    # ==================================================
    # VITE/ASTRO DEVELOPMENT ROUTES (MUST BE FIRST)
    # ==================================================
    
    # Vite/Astro dev source files - Very high rate limit for dev modules
    location ^~ /src/ {
        limit_req zone=vite_dev burst=200 nodelay;
        
        proxy_pass http://127.0.0.1:3003;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Allow node_modules for Vite dev dependencies (CRITICAL for Astro dev mode)
    location ^~ /node_modules/ {
        limit_req zone=vite_dev burst=200 nodelay;
        
        proxy_pass http://127.0.0.1:3003;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # Allow Vite dev server special routes (required for Astro 5 + Vite 7)
    location ^~ /@vite/ {
        limit_req zone=vite_dev burst=200 nodelay;
        
        proxy_pass http://127.0.0.1:3003;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    location ^~ /@id/ {
        limit_req zone=vite_dev burst=200 nodelay;
        
        proxy_pass http://127.0.0.1:3003;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    location ^~ /@react-refresh {
        limit_req zone=vite_dev burst=200 nodelay;
        
        proxy_pass http://127.0.0.1:3003;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ===========================================
    # SECURITY: COMPREHENSIVE FILE BLOCKING
    # ===========================================
    
    # Block hidden files and directories (.htaccess, .htpasswd, .git, .env, etc.)
    location ~ /\. {
        deny all;
        return 404;
    }
    
    # Block filesystem access attempts
    location ^~ /@fs/ {
        deny all;
        return 404;
    }
    
    # Block node_modules access (but allow Vite dev server to serve them)
    # In dev mode, Vite serves node_modules - so we skip this block
    
    # Block source code directories (but allow /src/ in dev mode for Vite HMR)
    # In dev mode, Vite needs access to /src/ for hot module replacement
    location ~ ^/(api|server|database|tests|documentation|scripts)/ {
        deny all;
        return 404;
    }
    
    # Block configuration files (exact match)
    location ~ ^/(package\.json|package-lock\.json|yarn\.lock|pnpm-lock\.yaml|tsconfig\.json|jsconfig\.json)$ {
        deny all;
        return 404;
    }
    
    location ~ \.(config|rc)\.(js|mjs|cjs|ts|json)$ {
        deny all;
        return 404;
    }
    
    # Block Docker files
    location ~ ^/(Dockerfile|docker-compose\.yml|\.dockerignore)$ {
        deny all;
        return 404;
    }
    
    # Block deployment and infrastructure files
    location ~ ^/(deploy\.sh|setup\.sh|backup.*\.sh|Makefile|fly\.toml|vercel\.json|netlify\.toml)$ {
        deny all;
        return 404;
    }
    
    location ~* \.(yml|yaml)$ {
        deny all;
        return 404;
    }
    
    # Block server files
    location ~ ^/server\.js$ {
        deny all;
        return 404;
    }
    
    # Block documentation and readme files
    location ~* \.(md|txt|pdf|doc|docx)$ {
        deny all;
        return 404;
    }
    
    # Block sensitive file extensions
    location ~* \.(key|pem|crt|p12|pfx|env|log|bak|backup|sql|db|sqlite|sqlite3|ini|cfg)$ {
        deny all;
        return 404;
    }
    
    # Block shell scripts
    location ~* \.(sh|bash|zsh|fish)$ {
        deny all;
        return 404;
    }
    
    # Block database directory
    location ^~ /database {
        deny all;
        return 404;
    }

    # Error pages
    error_page 502 503 504 /502.html;
    location = /502.html {
        root /opt/webcheck/public;
        internal;
    }

    # Backend API (use prefix match to catch all /api/* routes)
    location ^~ /api/ {
        # Stricter rate limiting for API
        limit_req zone=api burst=15 nodelay;
        
        proxy_pass http://127.0.0.1:3004;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 10s;
        proxy_intercept_errors on;
    }
    
    # Extra strict rate limiting for login endpoint
    location = /api/auth/login {
        limit_req zone=login burst=3 nodelay;
        
        proxy_pass http://127.0.0.1:3004;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 10s;
        proxy_intercept_errors on;
    }

    # Serve static assets
    location /assets/ {
        root /opt/webcheck/public;
        try_files $uri =404;
    }

    # Frontend - Astro Production (built static files served by Node)
    location / {
        proxy_pass http://127.0.0.1:3003;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 10s;
        # Do NOT intercept errors in production - let app handle them
        # proxy_intercept_errors off;
    }

    access_log /var/log/nginx/jetestemonsite_apdp_mc_access.log;
    error_log /var/log/nginx/jetestemonsite_apdp_mc_error.log;
}
